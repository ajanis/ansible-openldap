- name: Install autofs packages and supporting ldap packages
  package:
    name: "{{ openldap_autofs_packages }}"
    state: present
    update_cache: yes
  when:
    - openldap_server_enable_autofs

- name: Copy autofs defaults file
  template:
    src: autofs.j2
    dest: "{{ openldap_autofs_defaults_file }}"
    mode: 0755
  notify:
    - restart_autofs
  when:
    - openldap_server_enable_autofs


- name: Update /etc/autofs_ldap_auth.conf
  template:
    src: autofs_ldap_auth.conf.j2
    dest: /etc/autofs_ldap_auth.conf
    mode: 0600
  notify:
    - restart_autofs
  when:
    - openldap_server_enable_autofs

- name: Enable pam authentication in ssh server configuration
  lineinfile:
    dest: /etc/ssh/sshd_config
    state: present
    regexp: '^.*UsePam.*$'
    line: UsePAM yes
  notify:
    - restart_login_services
  when:
    - openldap_server_enable_posixaccounts
    - ansible_system != 'OpenBSD'
  tags:
    - always

- name: Append ssh-ldap-pubkey wrapper configs to sshd_config
  lineinfile:
    dest: /etc/ssh/sshd_config
    state: present
    line: 'AuthorizedKeysCommand {{ openldap_ldap_pubkey_wrapper }}'
  notify:
    - restart_login_services
  when:
    - openldap_server_enable_sshkeys

- name: Append ssh-ldap-pubkey user configs to sshd_config
  lineinfile:
    dest: /etc/ssh/sshd_config
    state: present
    line: 'AuthorizedKeysCommandUser {{ openldap_ldap_pubkey_user }}'
  notify:
    - restart_login_services
  when:

- name: Start rpcbind service
  service:
    name: rpcbind
    state: started
    enabled: yes
  when:
    - openldap_server_enable_autofs

- meta: flush_handlers

- name: Start AutoFS service
  service:
    name: autofs
    state: |-
      {%- if autofs_needs_restart|default('false') -%}
        restarted
      {%- else %}
        started
      {%- endif %}
    enabled: yes
  when:
    - openldap_server_enable_autofs



