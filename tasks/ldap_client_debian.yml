---
- name: Install the openldap client and required Packages [Debian/Ubuntu]
  apt:
    name: "{{ openldap_client_pkgs }}"
    state: present
    update_cache: yes

- import_tasks: ldap_tls_configure.yml
  when:
    - openldap_server_enable_tls
  tags:
    - openldap-tls

- name: Install ansible python dependencies for ldap configuration [Debian/Ubuntu]
  pip:
    name: |-
      {{ item.name }}
      {%- if (item.version is defined) and (item.version|length > 0) -%}
        =={{ item.version }}
      {%- endif %}
    state: |-
      {%- if (item.state is defined) and (item.state|length > 0) -%}
        {{ item.state }}
      {%- else -%}
        present
      {%- endif %}
  loop: "{{ openldap_python_pkgs }}"
  notify:
    - restart_login_services
  when:
    - openldap_python_pkgs is defined
    - openldap_python_pkgs|length > 0


- name: Copy /etc/ldap.conf for client [Debian/Ubuntu]
  template:
    src: client_ldap.conf.j2
    dest: /etc/ldap.conf
  notify:
    - restart_login_services
    - restart_ns_daemons

- name: Copy the ldap.conf configuration file [Debian/Ubuntu]
  template:
    src: ldap.conf.j2
    dest: "{{ openldap_server_app_path }}/ldap.conf"
  notify:
    - restart_login_services
    - restart_ns_daemons

- name: Fix common-auth [Debian/Ubuntu]
  lineinfile:
    dest: /etc/pam.d/common-auth
    state: present
    line: 'account required    pam_access.so'
  notify:
    - restart_ns_daemons
    - restart_login_services

- name: Fix common-session [Debian/Ubuntu]
  lineinfile:
    dest: /etc/pam.d/common-session
    state: present
    line: 'session required    pam_mkhomedir.so skel=/etc/skel umask=0022'
  notify:
    - restart_ns_daemons
    - restart_login_services

- name: Fix common-password [Debian/Ubuntu]
  replace:
    path: /etc/pam.d/common-password
    backup: yes
    regexp: '^.*use_authtok.*$'
    replace: 'password [success=1 user_unknown=ignore default=die] pam_ldap.so try_first_pass'
  notify:
    - restart_ns_daemons
    - restart_login_services

- name: Fix access.conf [Debian/Ubuntu]
  lineinfile:
    dest: /etc/security/access.conf
    state: absent
    line: '-:ALL EXCEPT root (admin):ALL EXCEPT LOCAL'
  notify:
    - restart_ns_daemons
    - restart_login_services

- name: Copy nsswitch.conf [Debian/Ubuntu]
  template:
    src: nsswitch.conf.j2
    dest: /etc/nsswitch.conf
  notify:
    - restart_ns_daemons

- name: Copy nslcd.conf [Debian/Ubuntu]
  template:
    src: nslcd.conf.j2
    dest: /etc/nslcd.conf
    mode: 0600
  notify:
    - restart_ns_daemons

- name: Ensure directory for nscd socket exists [Debian/Ubuntu]
  file:
    state: directory
    path: /var/run/nscd
    mode: 0755
  notify:
    - restart_ns_daemons

- import_tasks: ldap_autofs_install.yml
  when:
    - openldap_server_enable_autofs
  tags:
    - openldap-autofs

- meta: flush_handlers

- name: create user home directories [Debian/Ubuntu]
  file:
    state: directory
    path: "/home/{{ item.key }}"
    owner: "{{ item.value.uid }}"
    group: "{{ item.value.gid }}"
    mode: 0755
  with_dict: "{{ ssh_users }}"
  when:
    - not openldap_server_enable_autofs
