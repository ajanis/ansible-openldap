---
- name: Restart iptables
  listen: restart iptables
  ansible.builtin.service:
    name: iptables
    state: restarted
    enabled: true

- name: Fix ldap perms
  listen: restart slapd
  ansible.builtin.file:
    path: "{{ openldap_server_app_path }}"
    state: directory
    recurse: true
    owner: "{{ openldap_server_user }}"
    group: "{{ openldap_server_group }}"
    mode: "0755"
- name: Restart slapd
  listen: restart slapd
  ansible.builtin.service:
    name: slapd
    state: restarted
    enabled: true

- name: Restart httpd
  listen: restart httpd
  ansible.builtin.service:
    name: httpd
    state: restarted
    enabled: true

- name: Restart nscd
  listen: restart_ns_daemons
  ansible.builtin.service:
    name: nscd
    state: restarted
    enabled: true

- name: Restart_nslcd
  listen: restart_ns_daemons
  ansible.builtin.service:
    name: nslcd
    state: restarted
    enabled: true

- name: Restart_sssd
  listen: restart_ns_daemons
  ansible.builtin.service:
    name: sssd
    state: restarted
    enabled: true
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version >= "8"

- name: Restart_sshd
  listen: restart_login_services
  ansible.builtin.service:
    name: "{{ ssh_service }}"
    state: restarted
    enabled: true

- name: Require authconfig update
  ansible.builtin.set_fact:
    run_authconfig: true
  listen: restart_login_services

# - name: fix ldap perms
#   listen: restart_login_services
#   file:
#     path: "{{ openldap_server_app_path }}"
#     state: directory
#     recurse: yes
#     owner: "{{ openldap_server_user }}"
#     group: "{{ openldap_server_group }}"
#     mode: 0755
- name: Restart_systemd_logind
  listen: restart_login_services
  ansible.builtin.service:
    name: systemd-logind
    state: restarted
    enabled: true

- name: Restart_autofs
  listen: restart_autofs
  ansible.builtin.service:
    name: autofs
    state: restarted
    enabled: true

- name: Reload exports
  listen: reload exports
  ansible.builtin.command: exportfs -ra
  changed_when: false

- name: Restart samba
  listen: restart samba
  ansible.builtin.service:
    name: smbd
    state: restarted
    enabled: true

- name: Restart nmbd
  listen: restart nmbd
  ansible.builtin.service:
    name: nmbd
    state: restarted
    enabled: true

- name: Smbldap populate
  listen: smbldap populate
  ansible.builtin.set_fact:
    smbldap_populate: true

- name: Slapd rebuild
  listen: slapd rebuild
  ansible.builtin.set_fact:
    slapd_rebuild: true

- name: Restart avahi-daemon
  listen: restart avahi-daemon
  ansible.builtin.service:
    name: avahi-daemon
    state: restarted

- name: Restart netatalk
  listen: restart netatalk
  ansible.builtin.service:
    name: netatalk
    state: restarted
